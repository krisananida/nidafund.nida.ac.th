<?php
/*    if(isset($_POST['first_name']) && isset($_POST['last_name']) && isset($_POST['email']))
    {
*/        // include Database connection file
    include("dbcon.php");
    include("uplaodfile.php");

    $data = "NOT PASS";
    // get values
    $fname = trim($_POST['fname']);
    $lname = trim($_POST['lname']);
    $idcard = trim($_POST['idcard']);
    $email = trim($_POST['email']);
    $phone = trim($_POST['phone']);
    $address = trim($_POST['address']);
    $district = trim($_POST['district']);
    $provinceid = trim($_POST['province']);
    $postalcode = trim($_POST['postalcode']);
    $amount = trim($_POST['amount']);

    $query = "INSERT INTO dn1_tbillrequest(fname, lname, idcard, email, phone, address, district, provinceid, postalcode, amount)";
    $query .= "VALUES('$fname', '$lname', '$idcard', '$email', '$phone', '$address', '$district', '$provinceid', '$postalcode', '$amount' )";

    mysqli_begin_transaction($con, MYSQLI_TRANS_START_READ_WRITE);


    if (!$result = mysqli_query($con, $query)) {
        mysqli_rollback($con);
        mysqli_close($con);
        exit(mysqli_error($con));
    }

    /*
    else{
      $last_id = mysqli_insert_id($con);
      if(uploadfile($last_id)){
        mysqli_commit($con);
        mysqli_close($con);
        $data = "PASS";
      }
      else{
        mysqli_rollback($con);
        mysqli_close($con);
      }
    }
    */

    $last_id = mysqli_insert_id($con);
    $idstr = (string)sprintf("%'.06d", $last_id);
    $datestr = date("ymd");
    $target_dir = "../uploadfile/";
    $uploadfilename = $datestr  . "" . $idstr . "." . basename($_FILES["evidence"]["type"]);
    $target_file = $target_dir . $uploadfilename;
    $uploadOk = 1;
    $imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION));

    if (move_uploaded_file($_FILES["evidence"]["tmp_name"], $target_file)) {
        //echo $last_id . " " . $target_file . " The file ". basename( $_FILES["evidence"]["name"]). " has been uploaded.";
        $data = "PASS";
    } else {
        echo $target_file . "Sorry, there was an error uploading your file.";
    }

    $query = "UPDATE dn1_tbillrequest SET uploadfilename = '$uploadfilename' WHERE id = '$last_id'";
    if (!$result = mysqli_query($con, $query)) {
        mysqli_rollback($con);
        mysqli_close($con);
        exit(mysqli_error($con));
    }

/*
    }
*/
    $query = "SELECT * FROM dn1_tbillrequest WHERE id='$last_id'";
    if (!$result = mysqli_query($con, $query)) {
        mysqli_rollback($con);
        mysqli_close($con);
        exit(mysqli_error($con));
    }
    $row = mysqli_fetch_assoc($result);
    $file_dir = "http://demo01.donate.nida.ac.th/donate05/uploadfile/";
    $cid = $row['id'];
    $cfname = $row['fname'];
    $clname = $row['lname'];
    $cfilename = $file_dir.$row['uploadfilename'];
    $cdatetimereq = $row['datetimereq'];
    //$datatxt = "'$cid','$cfname','$clname','$cfilename','$cdatetimereq'\n";
    $datatxt = $cid . "," . $cfname . "," . $clname . "," . $cfilename . "," . $cdatetimereq ."\n";
    $datafile = fopen("../data/donatereqdata.csv", "a") or die("Unable to open file!");
    fwrite($datafile, $datatxt);
    fclose($datafile);

    mysqli_close($con);

    //echo $datatxt;
?>
